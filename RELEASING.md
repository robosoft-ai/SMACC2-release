# SMACC2 Release Process

This document details the process for creating a new SMACC2 release for ROS2 apt packages. The workflow involves Claude Code generating commands in a Docker container, while the human developer executes them on the host system due to GitHub authentication requirements.

## Workflow Overview

**Division of Labor:**
- **Claude Code (Docker)**: Analyzes code, prepares files, generates commands, creates documentation
- **Human Developer (Host)**: Executes git commands, handles GitHub authentication, runs bloom-release, creates PRs

**Why This Split?**
- Docker container lacks GitHub credentials for push/PR operations
- Host system has configured git identity and GitHub access tokens
- Bloom requires rosdep and GitHub API access from host environment

## Prerequisites (Host System)

### Required Tools

```bash
# Install bloom via pip (apt version may be outdated/unavailable)
pip3 install --user bloom

# Add to PATH (add to ~/.bashrc for persistence)
export PATH="$HOME/.local/bin:$PATH"

# Verify installation
which bloom-release  # Should show ~/.local/bin/bloom-release
```

### Git Configuration

```bash
# Configure git identity (if not already set)
git config user.email "your-email@example.com"
git config user.name "Your Name"

# Verify GitHub authentication
ssh -T git@github.com  # OR
gh auth status         # If using GitHub CLI
```

### Required Forks

1. Fork `ros/rosdistro` to your GitHub account
2. Ensure write access to `robosoft-ai/SMACC2` (maintainers only)
3. Ensure write access to `robosoft-ai/SMACC2-release` (maintainers only)

## Release Phases

### Phase 1: Pre-Release Verification (Claude in Docker)

Claude will:
1. Verify the bug fix or feature exists in source code
2. Review commit history since last release
3. Determine appropriate version number (major.minor.patch)
4. Analyze changes to categorize (fixes, features, breaking changes)

**Example:**
```bash
# Claude runs these internally:
git log 2.3.19..HEAD --oneline
git diff 2.3.19..HEAD -- "*.hpp" "*.cpp"
```

### Phase 2: Version & Documentation Updates (Claude in Docker)

Claude will:
1. Update all package.xml files (42+ packages) to new version
2. Generate comprehensive CHANGELOG.rst entry
3. Prepare commit message

**Human verifies and reviews changes before committing**

### Phase 3: Commit, Tag, and Push (Human on Host)

**Commands generated by Claude, executed by human:**

```bash
# Navigate to SMACC2 repository
cd /path/to/SMACC2

# Stage all version changes
git add -A

# Commit (Claude provides the commit message)
git commit -m "Prepare release X.Y.Z

[Claude-generated detailed commit message]

ü§ñ Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"

# Create annotated release tag
git tag -a X.Y.Z -m "Release X.Y.Z - [Primary fix/feature]"

# Verify tag includes critical commits
git log X.Y.Z --oneline | grep "critical-commit-hash"

# Push to feature branch first (for PR workflow)
git push origin your-branch-name
git push origin X.Y.Z

# Create PR to jazzy branch on GitHub
# Review and merge PR
```

**Important:** After PR is merged, ensure the tag X.Y.Z is on the jazzy branch. You may need to re-create the tag after merge if it was on a feature branch.

### Phase 4: Bloom Release Process (Human on Host)

**Fix Common Issues First:**

```bash
# Fix rosdep configuration (if needed)
# Check for broken rosdep sources
rosdep update

# If you see errors about missing local files:
sudo mv /etc/ros/rosdep/sources.list.d/10-debian.list \
        /etc/ros/rosdep/sources.list.d/10-debian.list.disabled

# Verify rosdep works
rosdep update  # Should complete without fatal errors
```

**Run Bloom Release:**

```bash
# Clone or navigate to release repository
cd /tmp
git clone https://github.com/robosoft-ai/SMACC2-release.git
cd SMACC2-release

# CRITICAL: Update tracks.yaml if needed
# If bloom previously failed or used wrong version:
sed -i 's/last_version: OLD_VERSION/last_version: X.Y.Z/g' tracks.yaml
git add tracks.yaml
git commit -m "Update tracks.yaml to version X.Y.Z"

# Run bloom release
bloom-release smacc2 --rosdistro jazzy --track jazzy --unsafe

# When prompted about missing dependencies:
# - Type 'y' if dependency is optional (e.g., demo packages)
# - Type 'n' if dependency is critical

# When prompted about creating fork/PR:
# - Type 'y' to attempt automatic PR creation
# - If it fails (403 error), you'll create PR manually
```

**Expected Output:**
```
Releasing package 'smacc2' for 'jazzy' to: 'release/jazzy/smacc2'
[... many package releases ...]
==> git-bloom-generate -y rosdebian --prefix release/jazzy jazzy -i 1
[... debian branch generation ...]

Open a pull request from 'username/rosdistro:bloom-smacc2-0' into 'ros/rosdistro:master'?
Continue [Y/n]? y
```

**If Automatic PR Fails:**

Bloom creates the commit locally but can't push due to authentication. The commit is in a temporary directory that gets cleaned up. You'll need to manually create the rosdistro PR.

### Phase 5: Manual rosdistro PR Creation (Human on Host)

**If bloom's automatic PR failed:**

```bash
# Clone your rosdistro fork
cd /tmp
git clone https://github.com/YOUR_USERNAME/rosdistro.git
cd rosdistro

# Create release branch from latest upstream
git remote add upstream https://github.com/ros/rosdistro.git
git fetch upstream
git checkout -b smacc2-X.Y.Z-release upstream/master

# Find the smacc2 entry
grep -n "smacc2:" jazzy/distribution.yaml
# Output: 10934:  smacc2:

# Update the version (Claude will provide the sed command)
sed -i 's/version: OLD_VERSION-REV/version: X.Y.Z-REV/g' jazzy/distribution.yaml

# Verify the change
sed -n 'LINE_NUMBER,LINE_NUMBER+15p' jazzy/distribution.yaml | grep version

# Commit and push
git add jazzy/distribution.yaml
git commit -m "smacc2: X.Y.Z-REV in 'jazzy/distribution.yaml' [bloom]"
git push origin smacc2-X.Y.Z-release
```

**Create PR on GitHub:**
- Go to your fork: `https://github.com/YOUR_USERNAME/rosdistro`
- Click "Compare & pull request"
- **Base:** `ros/rosdistro:master`
- **Title:** `smacc2: X.Y.Z-REV in 'jazzy/distribution.yaml' [bloom]`
- **Description:**
  ```markdown
  Increasing version of package(s) in repository `smacc2` to `X.Y.Z-REV`:

  - upstream repository: https://github.com/robosoft-ai/SMACC2.git
  - release repository: https://github.com/robosoft-ai/SMACC2-release.git
  - distro file: `jazzy/distribution.yaml`
  - bloom version: `0.13.0`
  - previous version for package: `OLD_VERSION-REV`
  ```

### Phase 6: Documentation & Communication (Claude + Human)

**Claude generates, human publishes:**

**1. GitHub Release Notes**
- Go to: `https://github.com/robosoft-ai/SMACC2/releases/new`
- Select tag: `X.Y.Z`
- Copy title and description from Claude's prepared notes
- Publish release

**2. Issue Update (if release fixes an issue)**
- Post Claude-generated comment on relevant issue
- Include installation instructions for both apt and source users
- Note expected timeline for apt availability (24-48 hours)

**3. rosdistro PR Link**
- Update issue/release notes with rosdistro PR link once created

### Phase 7: Monitor & Verify (Human on Host)

**Timeline:**
- **Day 0:** Release created, rosdistro PR submitted
- **Day 1-2:** ROS maintainers review and merge rosdistro PR
- **Day 2-3:** Buildfarm compiles packages
- **Day 3-4:** Packages sync to apt.ros.org

**Monitoring Commands:**

```bash
# Check rosdistro PR status
# Visit: https://github.com/ros/rosdistro/pulls

# Check buildfarm status (after PR merge)
# Visit: https://build.ros2.org/job/Hbin_uJ64__smacc2__ubuntu_jammy_amd64__binary/

# Check apt package availability
apt-cache policy ros-jazzy-smacc2
# Should eventually show: Version: X.Y.Z-REVjammy...

# Verify on clean system
docker run -it ros:jazzy-ros-base bash
apt update
apt install ros-jazzy-smacc2
apt show ros-jazzy-smacc2 | grep Version
```

**Final Steps:**
- Update issue with confirmation of apt availability
- Close related issues
- Announce release in appropriate channels

## Common Issues & Solutions

### Issue 1: Bloom Uses Wrong Version

**Symptom:**
```
Releasing package 'smacc2' for 'jazzy' to: 'release/jazzy/smacc2'
ros-jazzy-smacc2 (2.3.18-1jammy) jammy; urgency=high  # <-- OLD VERSION!
```

**Solution:**
```bash
cd /tmp/SMACC2-release
# Manually update tracks.yaml
sed -i 's/last_version: OLD_VERSION/last_version: X.Y.Z/g' tracks.yaml
git add tracks.yaml
git commit -m "Update tracks.yaml to version X.Y.Z"
# Re-run bloom-release
bloom-release smacc2 --rosdistro jazzy --track jazzy --unsafe
```

### Issue 2: rosdep Update Fails

**Symptom:**
```
ERROR: unable to process source [file:///usr/share/python3-rosdep2/debian.yaml]:
Failed to update rosdep, did you run 'rosdep init' first?
```

**Solution:**
```bash
# Disable broken local rosdep source
sudo mv /etc/ros/rosdep/sources.list.d/10-debian.list \
        /etc/ros/rosdep/sources.list.d/10-debian.list.disabled

# Verify fix
rosdep update
# Should show warnings but complete successfully
```

### Issue 3: Missing Dependency in Bloom

**Symptom:**
```
Could not resolve rosdep key 'some_package'
Failed to resolve some_package on ubuntu:jammy
```

**Solution:**
- If dependency is for optional/demo packages: Answer **'y'** to continue
- If dependency is critical: Fix the dependency issue before proceeding
- Most SMACC2 demo state machines have optional dependencies that can be skipped

### Issue 4: Tag Not on Correct Branch

**Symptom:**
Tag was created on feature branch, then PR was merged to jazzy, but tag isn't on jazzy branch.

**Solution:**
```bash
# After PR is merged to jazzy
git checkout jazzy
git pull origin jazzy

# Re-create tag on jazzy branch
git tag -d X.Y.Z  # Delete local tag
git push origin :refs/tags/X.Y.Z  # Delete remote tag
git tag -a X.Y.Z -m "Release X.Y.Z - [description]"
git push origin X.Y.Z

# Verify tag is on jazzy
git branch --contains X.Y.Z
# Should show: jazzy
```

### Issue 5: GitHub Authentication Fails

**Symptom:**
```
fatal: could not read Username for 'https://github.com': No such device or address
```

**Solution:**
Ensure you're on the host system (not Docker) with configured GitHub credentials:
```bash
# Use SSH URLs (recommended)
git remote set-url origin git@github.com:robosoft-ai/SMACC2.git

# OR use GitHub CLI
gh auth login

# OR use personal access token
# Create token at: https://github.com/settings/tokens
git config --global credential.helper store
git push  # Will prompt for username and token
```

## Version Numbering Guidelines

**Semantic Versioning (MAJOR.MINOR.PATCH):**

- **PATCH (X.Y.Z ‚Üí X.Y.Z+1):** Bug fixes, no API changes
  - Example: Fixing double onExit() calls
  - Most common for maintenance releases

- **MINOR (X.Y.Z ‚Üí X.Y+1.0):** New features, backward compatible
  - Example: New client library (cl_moveit2z)
  - Component additions
  - Non-breaking API extensions

- **MAJOR (X.Y.Z ‚Üí X+1.0.0):** Breaking changes
  - Example: Namespace restructuring that breaks user code
  - Signature changes to public APIs
  - Removed deprecated features

**Debian Revision (-REV):**
- Increments with each bloom release for same upstream version
- Usually `-1` for first release, `-2` if you need to re-release
- Example: `2.3.20-1`, `2.3.20-2`

## Release Checklist

**Before Starting:**
- [ ] Verify you have maintainer access to SMACC2 repositories
- [ ] Fork `ros/rosdistro` to your GitHub account
- [ ] Install bloom on host: `pip3 install --user bloom`
- [ ] Configure git identity on host
- [ ] Test GitHub authentication

**Release Steps:**
- [ ] Claude verifies fix/feature in code
- [ ] Claude reviews commits and determines version
- [ ] Claude updates package.xml files (42 packages)
- [ ] Claude generates CHANGELOG entry
- [ ] Human commits and pushes changes
- [ ] Human creates and merges PR to jazzy branch
- [ ] Human creates and pushes release tag
- [ ] Human fixes rosdep issues (if any)
- [ ] Human runs bloom-release
- [ ] Human creates rosdistro PR (manual if bloom fails)
- [ ] Human creates GitHub release with Claude's notes
- [ ] Human posts issue updates
- [ ] Human monitors rosdistro PR merge (1-2 days)
- [ ] Human monitors buildfarm (1-2 days after merge)
- [ ] Human verifies apt package availability
- [ ] Human closes related issues

**Time Estimates:**
- Active work: 2-4 hours (spread across Claude + Human)
- Total calendar time: 3-5 days (waiting for buildfarm)

## Reference Files

**Version Locations:**
- All package.xml files: `find . -name package.xml | xargs grep "<version>"`
- Main package: `smacc2/package.xml`
- Messages: `smacc2_msgs/package.xml`

**Documentation:**
- Main CHANGELOG: `smacc2/CHANGELOG.rst`
- Release tracks: `https://github.com/robosoft-ai/SMACC2-release/blob/master/tracks.yaml`
- rosdistro entry: `https://github.com/ros/rosdistro/blob/master/jazzy/distribution.yaml`

**Monitoring:**
- Buildfarm: `https://build.ros2.org/`
- Apt packages: `http://packages.ros.org/ros2/ubuntu/pool/main/r/ros-jazzy-smacc2/`
- rosdistro PRs: `https://github.com/ros/rosdistro/pulls`

## Example: Release 2.3.20 Process

This section documents the actual release process for version 2.3.20, which fixed the critical double onExit() bug (#556).

### Initial Analysis

```bash
# Claude verified the fix
git log --oneline | grep "double finishing"
# Output: 1fabc680 remove double finishing (#558)

# Reviewed commits since 2.3.19
git log 2.3.19..HEAD --oneline
# Found 54 commits including the fix and major refactoring

# Decision: 2.3.20 (patch release for critical bug fix)
```

### Version Updates

```bash
# Claude updated all 42 package.xml files
find . -name "package.xml" -exec sed -i 's/<version>2\.3\.19<\/version>/<version>2.3.20<\/version>/g' {} \;

# Verified
find . -name "package.xml" -exec grep -H "<version>" {} \; | grep -v "2.3.20" | wc -l
# Output: 0 (all updated)
```

### Commit and Tag

```bash
# Configured git on host
git config user.email "brett@robosoft.ai"
git config user.name "brettpac"

# Committed changes
git add -A
git commit -m "Prepare release 2.3.20..."

# Created tag
git tag -a 2.3.20 -m "Release 2.3.20 - Fix double onExit() calls (#556)"

# Pushed (after PR merge to jazzy)
git push origin jazzy
git push origin 2.3.20
```

### Bloom Release

```bash
# Fixed rosdep issue
sudo mv /etc/ros/rosdep/sources.list.d/10-debian.list \
        /etc/ros/rosdep/sources.list.d/10-debian.list.disabled

# Updated tracks.yaml (bloom initially used old version)
cd /tmp/SMACC2-release
sed -i 's/last_version: 2\.3\.18/last_version: 2.3.20/g' tracks.yaml
git add tracks.yaml
git commit -m "Update tracks.yaml to version 2.3.20"

# Ran bloom
bloom-release smacc2 --rosdistro jazzy --track jazzy --unsafe
# Answered 'y' to missing ros_publisher_client dependency (optional demo package)
# Automatic PR failed with 403 error
```

### Manual rosdistro PR

```bash
# Cloned fork
cd /tmp
git clone https://github.com/brettpac/rosdistro.git
cd rosdistro
git remote add upstream https://github.com/ros/rosdistro.git
git fetch upstream
git checkout -b smacc2-2.3.20-release upstream/master

# Updated version
grep -n "smacc2:" jazzy/distribution.yaml
# Output: 10934:  smacc2:
sed -i 's/version: 2\.3\.18-1/version: 2.3.20-2/g' jazzy/distribution.yaml

# Committed and pushed
git add jazzy/distribution.yaml
git commit -m "smacc2: 2.3.20-2 in 'jazzy/distribution.yaml' [bloom]"
git push origin smacc2-2.3.20-release

# Created PR on GitHub
# PR link: [to be filled after creation]
```

### Outcome

- ‚úÖ Version 2.3.20 released with double onExit() fix
- ‚úÖ All 42 packages version-locked at 2.3.20
- ‚úÖ Comprehensive CHANGELOG entry created
- ‚úÖ Debian release branches created with 2.3.20-2
- ‚úÖ rosdistro PR submitted
- ‚è≥ Awaiting buildfarm (24-48 hours)

## References

- [Bloom Documentation](http://wiki.ros.org/bloom)
- [ROS2 Release Process](https://docs.ros.org/en/rolling/How-To-Guides/Releasing/First-Time-Release.html)
- [rosdistro Repository](https://github.com/ros/rosdistro)
- [Semantic Versioning](https://semver.org/)
- [ROS2 Buildfarm](https://build.ros2.org/)
